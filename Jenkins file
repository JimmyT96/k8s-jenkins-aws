pipeline {
    agent any

    environment {
        DOCKER_IMAGE_NAME = "jhooq-spring-boot-docker-compose"
        DOCKER_HUB_USER   = "jemimaht"
        DOCKER_CREDS_ID   = "docker-hub-credentials"
        
        EKS_CLUSTER_NAME  = "jhooq-eks-cluster"
        AWS_REGION        = "us-east-1"
        KUBE_CREDS_ID     = "eks-kubeconfig"
    }

    tools {
        jdk "JDK-11"
        gradle "Gradle-6.3"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Artifact') {
            steps {
                sh 'gradle clean build -x test'
            }
        }

        stage('Docker Build & Push') {
            steps {
                script {
                    docker.withRegistry('', "${DOCKER_CREDS_ID}") {
                        def appImage = docker.build("${DOCKER_HUB_USER}/${DOCKER_IMAGE_NAME}:${env.BUILD_NUMBER}")
                        appImage.push()
                        appImage.push("latest")
                    }
                }
            }
        }

        stage('EKS Deployment') {
            steps {
                script {
                    sh "sed -i 's|image:.*|image: ${DOCKER_HUB_USER}/${DOCKER_IMAGE_NAME}:${env.BUILD_NUMBER}|' k8s-spring-boot.yml"
                    
                    withKubeConfig([credentialsId: "${KUBE_CREDS_ID}", clusterName: "${EKS_CLUSTER_NAME}"]) {
                        sh "kubectl apply -f k8s-spring-boot.yml"
                    }
                }
            }
        }
    }

    post {
        success {
            echo "Successfully deployed Build #${env.BUILD_NUMBER} to EKS."
        }
        failure {
            echo "Build #${env.BUILD_NUMBER} failed. Check console output for errors."
        }
        always {
            cleanWs()
        }
    }
}
